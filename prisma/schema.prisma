generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int                 @id @default(autoincrement())
  username        String              @unique @db.VarChar(100)
  password_hash   String              @db.VarChar(255)
  role            UserRole            @default(facility)
  is_active       Boolean?            @default(true)
  last_login      DateTime?           @db.Timestamptz(6)
  created_at      DateTime?           @default(now()) @db.Timestamptz(6)
  email           String?             @unique @db.VarChar(255)
  facility_id     String?
  field_values    FieldValue[]
  facility        Facility?           @relation(fields: [facility_id], references: [id], onDelete: Cascade)

  @@index([facility_id])
  @@map("user")
}

model District {
  id           String              @id @default(cuid())
  name         String              @unique @db.VarChar(100)
  created_at   DateTime            @default(now()) @db.Timestamptz(6)
  updated_at   DateTime            @updatedAt @db.Timestamptz(6)
  facilities   Facility[]

  @@map("district")
}

model FacilityType {
  id                 String                    @id @default(cuid())
  name               String                    @unique @db.VarChar(100)
  created_at         DateTime                  @default(now()) @db.Timestamptz(6)
  description        String?                   @db.VarChar(500)
  display_name       String                    @db.VarChar(200)
  is_active          Boolean                   @default(true)
  updated_at         DateTime                  @updatedAt @db.Timestamptz(6)
  facilities         Facility[]
  field_mappings     FacilityFieldMapping[]
  remunerations      FacilityTypeRemuneration?
  worker_allocations WorkerAllocationConfig[]

  @@map("facility_type")
}

model Facility {
  id                        String                       @id @default(cuid())
  name                      String                       @db.VarChar(200)
  created_at                DateTime                     @default(now()) @db.Timestamptz(6)
  description               String?                      @db.VarChar(500)
  display_name              String                       @db.VarChar(200)
  district_id               String
  facility_type_id          String
  is_active                 Boolean                      @default(true)
  updated_at                DateTime                     @updatedAt @db.Timestamptz(6)
  remuneration_records      FacilityRemunerationRecord[]
  worker_remunerations      WorkerRemuneration[]
  district                  District                     @relation(fields: [district_id], references: [id])
  facility_type             FacilityType                 @relation(fields: [facility_type_id], references: [id])
  facility_targets          FacilityTarget[]
  field_values              FieldValue[]
  health_workers            HealthWorker[]
  remuneration_calculations RemunerationCalculation[]
  users                     User[]

  @@unique([name, district_id])
  @@index([district_id])
  @@index([facility_type_id])
  @@map("facility")
}

model Indicator {
  id                        Int                          @id @default(autoincrement())
  name                      String                       @db.VarChar(200)
  description               String?
  type                      String                       @db.VarChar(20)
  structure                 Json?
  created_at                DateTime                     @default(now()) @db.Timestamptz(6)
  updated_at                DateTime                     @updatedAt @db.Timestamptz(6)
  code                      String                       @unique @db.VarChar(50)
  applicable_facility_types Json?
  conditions                String?                      @db.VarChar(1000)
  denominator_field_id      Int?
  denominator_label         String?                      @db.VarChar(200)
  formula_config            Json?
  formula_type              formula_type                 @default(RANGE_BASED)
  numerator_field_id        Int?
  numerator_label           String?                      @db.VarChar(200)
  target_formula            String?                      @db.VarChar(500)
  target_type               TargetType                   @default(PERCENTAGE)
  target_value              String?                      @db.VarChar(100)
  target_field_id           Int?
  source_of_verification    String?                      @db.VarChar(100)
  remuneration_records      FacilityRemunerationRecord[]
  facility_targets          FacilityTarget[]
  denominator_field         Field?                       @relation("DenominatorField", fields: [denominator_field_id], references: [id])
  numerator_field           Field?                       @relation("NumeratorField", fields: [numerator_field_id], references: [id])
  target_field              Field?                       @relation("TargetField", fields: [target_field_id], references: [id])
  remunerations             IndicatorRemuneration[]
  worker_allocations        IndicatorWorkerAllocation[]

  @@map("indicator")
}

model Field {
  id                         Int                     @id @default(autoincrement())
  code                       String                  @unique @db.VarChar(50)
  name                       String                  @db.VarChar(200)
  description                String?                 @db.VarChar(500)
  created_at                 DateTime                @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime                @updatedAt @db.Timestamptz(6)
  calculation_formula        String?                 @db.VarChar(500)
  default_value              String?                 @db.VarChar(100)
  facility_type_targets      Json?
  field_type                 FieldType
  is_active                  Boolean                 @default(true)
  sort_order                 Int                     @default(0)
  user_type                  UserType
  validation_rules           Json?
  field_category             FieldCategory           @default(DATA_FIELD)
  facility_field_mappings    FacilityFieldMapping[]
  field_values               FieldValue[]
  denominator_for_indicators Indicator[]             @relation("DenominatorField")
  numerator_for_indicators   Indicator[]             @relation("NumeratorField")
  target_for_indicators      Indicator[]             @relation("TargetField")

  @@map("field")
}

model FieldValue {
  id              Int       @id @default(autoincrement())
  field_id        Int
  report_month    String    @db.VarChar(7)
  string_value    String?   @db.VarChar(500)
  numeric_value   Decimal?  @db.Decimal(15, 2)
  boolean_value   Boolean?
  json_value      Json?
  uploaded_by     Int
  remarks         String?
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @updatedAt @db.Timestamptz(6)
  is_override     Boolean   @default(false)
  override_reason String?   @db.VarChar(200)
  facility_id     String?
  facility        Facility? @relation(fields: [facility_id], references: [id])
  field           Field     @relation(fields: [field_id], references: [id])
  uploader        User      @relation(fields: [uploaded_by], references: [id])

  @@unique([field_id, facility_id, report_month])
  @@map("field_value")
}

model FacilityFieldMapping {
  id               Int          @id @default(autoincrement())
  field_id         Int
  is_required      Boolean      @default(false)
  display_order    Int          @default(0)
  created_at       DateTime     @default(now()) @db.Timestamptz(6)
  updated_at       DateTime     @updatedAt @db.Timestamptz(6)
  facility_type_id String
  facility_type    FacilityType @relation(fields: [facility_type_id], references: [id], onDelete: Cascade)
  field            Field        @relation(fields: [field_id], references: [id], onDelete: Cascade)

  @@unique([facility_type_id, field_id])
  @@map("facility_field_mapping")
}

model HealthWorker {
  id                        Int                          @id @default(autoincrement())
  facility_id               String
  name                      String
  worker_type               String
  allocated_amount          Decimal                      @db.Decimal(10, 2)
  contact_number            String?
  email                     String?
  is_active                 Boolean                      @default(true)
  created_at                DateTime                     @default(now()) @db.Timestamptz(6)
  updated_at                DateTime                     @updatedAt @db.Timestamptz(6)
  facility                  Facility                     @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  remuneration_calculations WorkerRemuneration[]

  @@map("health_workers")
}

model RemunerationCalculation {
  id                        Int      @id @default(autoincrement())
  facility_id               String
  report_month              String   @db.VarChar(7)
  performance_percentage    Decimal  @db.Decimal(5, 2)
  facility_remuneration     Decimal  @db.Decimal(10, 2)
  total_worker_remuneration Decimal  @db.Decimal(10, 2)
  total_remuneration        Decimal  @db.Decimal(10, 2)
  health_workers_count      Int      @default(0)
  asha_workers_count        Int      @default(0)
  calculated_at             DateTime @default(now()) @db.Timestamptz(6)
  facility                  Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)

  @@unique([facility_id, report_month])
  @@map("remuneration_calculations")
}

model WorkerRemuneration {
  id                     Int          @id @default(autoincrement())
  health_worker_id       Int
  facility_id            String       // Add facility_id for better querying
  report_month           String       @db.VarChar(7)
  worker_type            String       // Add worker type (hw, asha, hwo, etc.)
  worker_role            String       // Add worker role (HW, ASHA, HWO, etc.)
  allocated_amount       Decimal      @db.Decimal(10, 2)
  performance_percentage Decimal      @db.Decimal(5, 2)
  calculated_amount      Decimal      @db.Decimal(10, 2)
  calculated_at          DateTime     @default(now()) @db.Timestamptz(6)
  
  // Relations
  health_worker          HealthWorker @relation(fields: [health_worker_id], references: [id], onDelete: Cascade)
  facility               Facility     @relation(fields: [facility_id], references: [id], onDelete: Cascade)

  @@unique([health_worker_id, report_month])
  @@index([facility_id, report_month])
  @@index([worker_type])
  @@map("worker_remunerations")
}

model WorkerAllocationConfig {
  id                   Int                        @id @default(autoincrement())
  facility_type_id     String
  worker_type          String
  worker_role          String
  max_count            Int                        @default(1)
  allocated_amount     Decimal                    @db.Decimal(10, 2)
  description          String?
  is_active            Boolean                    @default(true)
  created_at           DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at           DateTime                   @updatedAt @db.Timestamptz(6)
  facility_type        FacilityType               @relation(fields: [facility_type_id], references: [id], onDelete: Cascade)

  @@unique([facility_type_id, worker_type, worker_role])
  @@map("worker_allocation_config")
}

model FacilityTypeRemuneration {
  id                      Int                     @id @default(autoincrement())
  total_amount            Decimal                 @db.Decimal(10, 2)
  effective_from          DateTime                @default(now()) @db.Timestamptz(6)
  effective_to            DateTime?               @db.Timestamptz(6)
  created_at              DateTime                @default(now()) @db.Timestamptz(6)
  updated_at              DateTime                @updatedAt @db.Timestamptz(6)
  facility_type_id        String                  @unique
  facility_type           FacilityType            @relation(fields: [facility_type_id], references: [id])
  indicator_remunerations IndicatorRemuneration[]

  @@map("facility_type_remuneration")
}

model IndicatorRemuneration {
  id                            Int                      @id @default(autoincrement())
  facility_type_remuneration_id Int
  indicator_id                  Int
  base_amount                   Decimal                  @db.Decimal(10, 2)
  conditional_amount            Decimal?                 @db.Decimal(10, 2)
  condition_type                String?                  @db.VarChar(50)
  created_at                    DateTime                 @default(now()) @db.Timestamptz(6)
  updated_at                    DateTime                 @updatedAt @db.Timestamptz(6)
  facility_type_remuneration    FacilityTypeRemuneration @relation(fields: [facility_type_remuneration_id], references: [id])
  indicator                     Indicator                @relation(fields: [indicator_id], references: [id])

  @@unique([facility_type_remuneration_id, indicator_id])
  @@map("indicator_remuneration")
}

model FacilityTarget {
  id                Int       @id @default(autoincrement())
  indicator_id      Int
  report_month      String    @db.VarChar(7)
  target_value      Decimal   @db.Decimal(15, 2)
  numerator_label   String    @db.VarChar(200)
  denominator_label String    @db.VarChar(200)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @updatedAt @db.Timestamptz(6)
  facility_id       String
  facility          Facility  @relation(fields: [facility_id], references: [id])
  indicator         Indicator @relation(fields: [indicator_id], references: [id])

  @@unique([facility_id, indicator_id, report_month])
  @@map("facility_target")
}

model IndicatorWorkerAllocation {
  id               String    @id @default(cuid())
  indicator_id     Int
  worker_type      String    @db.VarChar(50)
  allocated_amount Int
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @updatedAt @db.Timestamptz(6)
  indicator        Indicator @relation(fields: [indicator_id], references: [id], onDelete: Cascade)

  @@unique([indicator_id, worker_type])
  @@map("indicator_worker_allocation")
}

model FacilityRemunerationRecord {
  id                     String        @id @default(cuid())
  facility_id            String
  report_month           String
  indicator_id           Int?
  
  // Performance data (for indicators)
  actual_value           Float?
  target_value           Json?         // JSON to store min/max ranges like indicators table
  percentage_achieved    Float?
  status                 String        // "achieved", "partial", "not_achieved"
  
  // Remuneration data (for indicators)
  incentive_amount       Float         @default(0)
  max_remuneration       Float?
  raw_percentage         Float?
  
  // Metadata
  calculation_date       DateTime      @default(now())
  calculation_version    String        @default("1.0")
  
  // Historical accuracy fields
  kpi_config_snapshot    Json?
  remuneration_formula_snapshot Json?
  worker_allocation_snapshot Json?
  calculation_metadata   Json?
  
  facility               Facility      @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  indicator              Indicator?    @relation(fields: [indicator_id], references: [id], onDelete: Cascade)

  @@unique([facility_id, report_month, indicator_id])
  @@index([facility_id, report_month])
  @@index([report_month])
  @@index([indicator_id])
  @@index([calculation_version])
}

enum UserRole {
  admin
  facility

  @@map("user_role")
}

enum UserType {
  ADMIN
  FACILITY
}

enum FieldType {
  CONSTANT
  FACILITY_SPECIFIC
  MONTHLY_COUNT
  BINARY
  PERCENTAGE
  CALCULATED
  INDICATOR_REFERENCE
  FACILITY_TYPE_SPECIFIC
}

enum ValidationRule {
  REQUIRED
  POSITIVE_NUMBER
  PERCENTAGE_RANGE
  DATE_RANGE
  CUSTOM_FORMULA
  BINARY_ONLY
  MIN_VALUE
  MAX_VALUE
}

enum CalculationType {
  DIRECT_INPUT
  CALCULATED
  AGGREGATED
  PERCENTAGE

  @@map("calculation_type")
}

enum DataQuality {
  PENDING
  VALIDATED
  APPROVED
  REJECTED

  @@map("data_quality")
}

enum UploadStatus {
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED

  @@map("upload_status")
}

enum TargetType {
  PERCENTAGE
  CONSTANT_VALUE
  BINARY
  RANGE
  MINIMUM_THRESHOLD
  MAXIMUM_THRESHOLD
  PERCENTAGE_RANGE

  @@map("target_type")
}

enum FieldCategory {
  DATA_FIELD
  TARGET_FIELD

  @@map("field_category")
}

enum formula_type {
  RANGE_BASED
  PERCENTAGE_CAP
  BINARY
  THRESHOLD_BONUS
  MINIMUM_THRESHOLD
  PERCENTAGE_RANGE
}
